<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoFan: Tactical Balance</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --sea: #0f172a; --panel: #1e293b; --accent: #38bdf8;
            --p1: #ef4444; --p2: #22c55e; --p3: #eab308;
            --p4: #a855f7; --p5: #f97316; --p6: #06b6d4;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--sea); color: #fff; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        #lobby { position: fixed; inset: 0; background: var(--sea); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .box { background: var(--panel); padding: 30px; border-radius: 20px; border: 2px solid var(--accent); text-align: center; width: 350px; }
        input { width: 80%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; background: #0f172a; color: #fff; }
        button { padding: 12px 20px; border-radius: 8px; border: none; background: var(--accent); cursor: pointer; font-weight: bold; }

        #game { display: none; width: 100%; grid-template-columns: 280px 1fr 280px; gap: 10px; padding: 10px; box-sizing: border-box; }
        #map-area { background: #020617; border-radius: 20px; display: flex; flex-wrap: wrap; justify-content: space-around; align-items: center; padding: 20px; position: relative; }

        .island { width: 180px; height: 180px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; padding: 15px; background: rgba(255,255,255,0.05); clip-path: polygon(20% 0%, 80% 0%, 100% 20%, 100% 80%, 80% 100%, 20% 100%, 0% 80%, 0% 20%); }
        .cell { background: #334155; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); }

        .side { background: var(--panel); border-radius: 15px; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .log { flex: 1; background: #000; border-radius: 10px; padding: 10px; font-size: 11px; color: #94a3b8; overflow-y: auto; }
        
        /* –≠–ö–†–ê–ù –ü–û–ë–ï–î–´ */
        #end-screen { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .end-icon { font-size: 80px; margin-bottom: 20px; }

        .p-item { padding: 8px; border-radius: 6px; margin-bottom: 5px; font-size: 13px; border-left: 4px solid #fff; }
        .active-turn { border: 2px solid var(--accent); background: rgba(56, 189, 248, 0.1); }
    </style>
</head>
<body>

<div id="lobby">
    <div class="box">
        <h2>GeoFan Online</h2>
        <input type="text" id="nick" placeholder="–¢–≤–æ–π –Ω–∏–∫">
        <input type="text" id="room" placeholder="ID –ö–æ–º–Ω–∞—Ç—ã">
        <button onclick="join()">–ü–û–î–ö–õ–Æ–ß–ò–¢–¨–°–Ø</button>
        <div id="wait" style="display:none; margin-top:20px;">
            <div id="p-list" style="text-align:left; margin-bottom:15px;"></div>
            <button id="start-btn" onclick="start()" style="background:var(--p2); display:none;">–ù–ê–ß–ê–¢–¨ –ò–ì–†–£</button>
        </div>
    </div>
</div>

<div id="end-screen">
    <div class="end-icon" id="end-icon">üèÜ</div>
    <h1 id="end-title">–ü–û–ë–ï–î–ê!</h1>
    <p id="end-msg"></p>
    <button onclick="location.reload()">–í –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ</button>
</div>

<div id="game">
    <div class="side">
        <h3 id="m-nick" style="color:var(--accent); margin:0;"></h3>
        <p id="m-country" style="font-size:12px; opacity:0.7;"></p>
        <div style="background:#0f172a; padding:10px; border-radius:10px;">
            üí∞ –ó–æ–ª–æ—Ç–æ: <b id="m-cash">0</b><br>
            ü™ñ –†–µ–∑–µ—Ä–≤: <b id="m-army">0</b><br>
            üìà –î–æ—Ö–æ–¥: <b id="m-eco">1.0</b>
        </div>
        <button onclick="action('eco')">üèóÔ∏è –≠–∫–æ–Ω–æ–º–∏–∫–∞ ($400)</button>
        <button onclick="action('army')">üõ°Ô∏è –ù–∞–Ω—è—Ç—å –≤–æ–π—Å–∫–æ ($250)</button>
        <button onclick="action('end')" style="background:var(--p2); color:#000; margin-top:20px;">–ó–ê–í–ï–†–®–ò–¢–¨ –•–û–î</button>
    </div>

    <div id="map-area"></div>

    <div class="side">
        <div id="turn-display" style="text-align:center; font-weight:bold; color:var(--accent); padding:5px; border:1px solid var(--accent); border-radius:5px;"></div>
        <h4>–ò–ì–†–û–ö–ò:</h4>
        <div id="game-p-list"></div>
        <h4>–õ–û–ì:</h4>
        <div class="log" id="game-log"></div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDyT4I-FHNm1UWV0IblzxBj7Gog9HpLCyY",
        databaseURL: "https://neuralarbitrage-default-rtdb.firebaseio.com",
        projectId: "neuralarbitrage",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myId, myRoom, state, isHost = false;
    const countries = [
        { name: "–ö—Ä–∞—Å–Ω—ã–π –õ–µ–≥–∏–æ–Ω", color: "#ef4444", cash: 600, army: 30, eco: 0.8 },
        { name: "–ó–µ–ª–µ–Ω—ã–π –õ–µ—Å", color: "#22c55e", cash: 1000, army: 20, eco: 1.2 },
        { name: "–ó–æ–ª–æ—Ç—ã–µ –ü–µ—Å–∫–∏", color: "#eab308", cash: 1800, army: 5, eco: 1.8 },
        { name: "–§–∏–æ–ª–µ—Ç–æ–≤—ã–π –ü–∏–∫", color: "#a855f7", cash: 800, army: 25, eco: 1.0 },
        { name: "–û—Ä–∞–Ω–∂–µ–≤—ã–π –†–∏—Ñ", color: "#f97316", cash: 900, army: 35, eco: 0.7 },
        { name: "–°–∏–Ω—è—è –í–æ–¥–∞", color: "#06b6d4", cash: 1200, army: 15, eco: 1.4 }
    ];

    async function join() {
        const nick = document.getElementById('nick').value;
        myRoom = document.getElementById('room').value;
        if(!nick || !myRoom) return;
        myId = nick + "_" + Math.floor(Math.random()*999);
        const ref = db.ref('geofan/rooms/' + myRoom);
        const snap = await ref.get();

        if(!snap.exists()) {
            isHost = true;
            await ref.set({
                status: 'lobby',
                players: [{id: myId, name: nick, cIdx: 0, dead: false}],
                turn: 0, log: ["–õ–æ–±–±–∏ —Å–æ–∑–¥–∞–Ω–æ."],
                cells: Array(36).fill(0).map((_, i) => ({owner: Math.floor(i/6), army: 15}))
            });
        } else {
            let d = snap.val();
            d.players.push({id: myId, name: nick, cIdx: d.players.length, dead: false});
            await ref.update({players: d.players});
        }
        document.getElementById('wait').style.display = 'block';
        ref.on('value', s => { state = s.val(); updateUI(); });
    }

    function updateUI() {
        if(state.status === 'lobby') {
            document.getElementById('p-list').innerHTML = state.players.map(p => `üë§ ${p.name}`).join('<br>');
            if(isHost) document.getElementById('start-btn').style.display = 'block';
        } else {
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('game').style.display = 'grid';
            checkWinCondition();
            renderMap();
        }
    }

    function checkWinCondition() {
        const activePlayers = [...new Set(state.cells.map(c => c.owner))];
        if(activePlayers.length === 1 && state.status === 'play') {
            const winner = state.players.find(p => p.cIdx === activePlayers[0]);
            showEndScreen(winner.id === myId);
        }
    }

    function showEndScreen(isWin) {
        const screen = document.getElementById('end-screen');
        screen.style.display = 'flex';
        document.getElementById('end-icon').innerText = isWin ? "üèÜ" : "üíÄ";
        document.getElementById('end-title').innerText = isWin ? "–ü–û–ë–ï–î–ê!" : "–ü–û–†–ê–ñ–ï–ù–ò–ï";
        document.getElementById('end-msg').innerText = isWin ? "–í—ã –∑–∞—Ö–≤–∞—Ç–∏–ª–∏ –≤–µ—Å—å –º–∏—Ä!" : "–í–∞—à–∞ —Å—Ç—Ä–∞–Ω–∞ –ø–∞–ª–∞.";
    }

    async function start() {
        state.players.forEach((p, i) => {
            Object.assign(p, countries[i]);
        });
        await db.ref('geofan/rooms/' + myRoom).update({status: 'play', players: state.players});
    }

    function renderMap() {
        const me = state.players.find(p => p.id === myId);
        document.getElementById('m-nick').innerText = me.name;
        document.getElementById('m-country').innerText = countries[me.cIdx].name;
        document.getElementById('m-cash').innerText = Math.floor(me.cash);
        document.getElementById('m-army').innerText = me.army;
        document.getElementById('m-eco').innerText = me.eco.toFixed(1);
        document.getElementById('turn-display').innerText = "–•–û–î: " + state.players[state.turn].name;

        document.getElementById('game-p-list').innerHTML = state.players.map((p, i) => {
            const hasCells = state.cells.some(c => c.owner === p.cIdx);
            return `<div class="p-item ${state.turn === i ? 'active-turn' : ''}" style="border-color:${countries[p.cIdx].color}; opacity: ${hasCells ? 1 : 0.4}">
                ${p.name} ${hasCells ? '' : '(–†–ê–ó–ë–ò–¢)'}
            </div>`;
        }).join('');

        const map = document.getElementById('map-area');
        map.innerHTML = '';
        for(let i=0; i<6; i++) {
            const isl = document.createElement('div');
            isl.className = 'island';
            isl.style.backgroundColor = countries[i].color + '15';
            state.cells.filter((_, idx) => Math.floor(idx/6) === i).forEach((cell, cellIdx) => {
                const gIdx = i*6 + cellIdx;
                const cDiv = document.createElement('div');
                cDiv.className = 'cell';
                cDiv.style.backgroundColor = countries[cell.owner].color;
                cDiv.innerText = cell.army;
                cDiv.onclick = () => handleAttack(gIdx);
                isl.appendChild(cDiv);
            });
            map.appendChild(isl);
        }
        document.getElementById('game-log').innerHTML = state.log.slice(-8).reverse().map(m => `> ${m}`).join('<br>');
    }

    async function handleAttack(idx) {
        if(state.players[state.turn].id !== myId) return;
        const me = state.players[state.turn];
        const cell = state.cells[idx];
        if(cell.owner === me.cIdx) return;

        const amount = prompt(`–£ —Ç–µ–±—è ${me.army} –≤–æ–∏–Ω–æ–≤. –°–∫–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å?`, me.army);
        const val = parseInt(amount);
        if(!val || val <= 0 || val > me.army) return;

        if(val * (Math.random() + 0.5) > cell.army * (Math.random() + 0.5)) {
            state.log.push(`${me.name} –∑–∞—Ö–≤–∞—Ç–∏–ª —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é!`);
            cell.owner = me.cIdx; cell.army = Math.floor(val * 0.4); me.army -= val;
        } else {
            state.log.push(`–ê—Ç–∞–∫–∞ ${me.name} –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å.`);
            me.army -= val;
        }
        await db.ref('geofan/rooms/' + myRoom).set(state);
    }

    async function action(type) {
        if(state.players[state.turn].id !== myId) return;
        const me = state.players[state.turn];
        if(type === 'eco' && me.cash >= 400) { me.cash -= 400; me.eco += 0.4; }
        else if(type === 'army' && me.cash >= 250) { me.cash -= 250; me.army += 15; }
        else if(type === 'end') {
            me.cash += (180 * me.eco);
            do { state.turn = (state.turn + 1) % state.players.length; } 
            while (!state.cells.some(c => c.owner === state.players[state.turn].cIdx));
        }
        await db.ref('geofan/rooms/' + myRoom).set(state);
    }
</script>
</body>
                                                 </html>
