<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoFan: Archipelago</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --sea: #082f49; --land: #1e293b; --accent: #38bdf8;
            --p1: #ef4444; --p2: #22c55e; --p3: #eab308;
            --p4: #a855f7; --p5: #f97316; --p6: #06b6d4;
        }
        body { font-family: 'Ubuntu', sans-serif; background: var(--sea); color: #fff; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* –õ–û–ë–ë–ò (—É–ø—Ä–æ—â–µ–Ω–æ –¥–ª—è –≤—Ö–æ–¥–∞) */
        #lobby { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.95); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        .box { background: #1e293b; padding: 40px; border-radius: 30px; border: 3px solid var(--accent); text-align: center; }
        input { display: block; width: 250px; padding: 15px; margin: 10px auto; border-radius: 10px; border: none; background: #0f172a; color: #fff; }
        button { padding: 15px 30px; border-radius: 10px; border: none; background: var(--accent); font-weight: bold; cursor: pointer; }

        /* –ò–ì–†–û–í–û–ï –ü–û–õ–ï */
        #game { display: none; display: grid; grid-template-columns: 300px 1fr 250px; height: 100%; gap: 10px; padding: 10px; box-sizing: border-box; }
        
        #map-area { 
            position: relative; 
            background: radial-gradient(circle, #0c4a6e 0%, #082f49 100%); 
            border-radius: 20px; 
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
            display: flex; flex-wrap: wrap; justify-content: space-around; align-items: center; padding: 20px;
        }

        /* –û–°–¢–†–û–í–ê */
        .island {
            position: relative;
            width: 220px; height: 220px;
            background: rgba(255,255,255,0.05);
            margin: 10px;
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 20px;
            /* –î–µ–ª–∞–µ–º —Ñ–æ—Ä–º—É –æ—Å—Ç—Ä–æ–≤–∞ ¬´–∫—Ä–∏–≤–æ–π¬ª */
            clip-path: polygon(10% 25%, 35% 10%, 75% 15%, 95% 40%, 85% 85%, 45% 95%, 5% 80%);
            border: 2px solid rgba(56, 189, 248, 0.2);
            transition: 0.5s;
        }

        /* –ö–ª–µ—Ç–∫–∏ –≤–Ω—É—Ç—Ä–∏ –æ—Å—Ç—Ä–æ–≤–æ–≤ */
        .cell {
            background: #475569;
            border-radius: 50% 20% 50% 10%; /* –°—Ç—Ä–∞–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ –∫–ª–µ—Ç–∫–∏ */
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 10px; font-weight: bold; color: #fff;
            cursor: pointer; transition: 0.3s;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .cell:hover { transform: scale(1.1) rotate(5deg); background: #64748b; }
        .cell-army { font-size: 14px; }

        .side { background: #1e293b; border-radius: 20px; padding: 20px; display: flex; flex-direction: column; gap: 15px; border: 1px solid #334155; }
        .log { flex: 1; background: #000; border-radius: 10px; padding: 10px; font-size: 12px; color: #38bdf8; overflow-y: auto; font-family: 'Courier New', monospace; }
        
        .turn-btn { background: var(--p2); color: #000; padding: 15px; font-weight: bold; border-radius: 10px; margin-top: auto; }
        .status-bar { font-size: 1.2em; font-weight: bold; color: var(--accent); text-align: center; margin-bottom: 20px; }
    </style>
</head>
<body>

<div id="lobby">
    <div class="box">
        <h1 style="color:var(--accent)">GeoFan: –û—Å—Ç—Ä–æ–≤–∞</h1>
        <input type="text" id="nick" placeholder="–¢–≤–æ–π –Ω–∏–∫">
        <input type="text" id="room" placeholder="ID –ö–æ–º–Ω–∞—Ç—ã">
        <button onclick="join()">–í–û–ô–¢–ò –í –°–ï–°–°–ò–Æ</button>
        <div id="lobby-wait" style="display:none; margin-top:20px;">
            <p>–ñ–¥–µ–º –∏–≥—Ä–æ–∫–æ–≤...</p>
            <button onclick="start()" style="background:var(--p2)">–°–¢–ê–†–¢</button>
        </div>
    </div>
</div>

<div id="game">
    <div class="side">
        <div id="player-info">
            <h2 id="m-nick">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
            <div style="font-size: 0.8em; opacity: 0.7;" id="m-country"></div>
            <hr>
            <p>üí∞ –î–µ–Ω—å–≥–∏: <span id="m-cash">0</span></p>
            <p>ü™ñ –ê—Ä–º–∏—è: <span id="m-army">0</span></p>
            <p>üèóÔ∏è –≠–∫–æ: <span id="m-eco">1.0</span></p>
        </div>
        <button onclick="action('eco')">üè¢ –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –∑–∞–≤–æ–¥ ($300)</button>
        <button onclick="action('army')">üõ°Ô∏è –ü—Ä–∏–∑–≤–∞—Ç—å –≤–æ–π—Å–∫–∞ ($200)</button>
        <button class="turn-btn" onclick="action('end')">–ó–ê–í–ï–†–®–ò–¢–¨ –•–û–î</button>
    </div>

    <div id="map-area">
        </div>

    <div class="side">
        <div class="status-bar" id="turn-name">–•–æ–¥: ...</div>
        <h3>–°–û–ë–´–¢–ò–Ø</h3>
        <div class="log" id="game-log"></div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDyT4I-FHNm1UWV0IblzxBj7Gog9HpLCyY",
        databaseURL: "https://neuralarbitrage-default-rtdb.firebaseio.com",
        projectId: "neuralarbitrage",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myId, myRoom, state, isHost = false;
    const countryStyles = [
        { name: "–û—Å—Ç—Ä–æ–≤ –í—É–ª–∫–∞–Ω–æ–≤", color: "#ef4444", clip: "polygon(20% 0%, 80% 0%, 100% 100%, 0% 100%)" },
        { name: "–õ–µ–¥—è–Ω–æ–π –ü–∏–∫", color: "#06b6d4", clip: "polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%)" },
        { name: "–ó–æ–ª–æ—Ç–æ–π –†–∏—Ñ", color: "#eab308", clip: "polygon(25% 0%, 100% 0%, 75% 100%, 0% 100%)" },
        { name: "–ó–µ–ª–µ–Ω–∞—è –õ–∞–≥—É–Ω–∞", color: "#22c55e", clip: "circle(50% at 50% 50%)" },
        { name: "–¢—É–º–∞–Ω–Ω—ã–π –ö—Ä–∞–π", color: "#a855f7", clip: "polygon(0% 15%, 100% 15%, 85% 85%, 15% 85%)" },
        { name: "–ñ–µ–ª–µ–∑–Ω–∞—è –°–∫–∞–ª–∞", color: "#f97316", clip: "polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%)" }
    ];

    async function join() {
        const nick = document.getElementById('nick').value;
        myRoom = document.getElementById('room').value;
        if(!nick || !myRoom) return alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è!");

        myId = nick + "_" + Math.floor(Math.random()*999);
        const ref = db.ref('geofan/r/' + myRoom);
        const snap = await ref.get();

        if(!snap.exists()) {
            isHost = true;
            await ref.set({
                status: 'lobby',
                players: [{id: myId, name: nick, cash: 1000, army: 50, eco: 1, countryIdx: 0}],
                turn: 0,
                log: ["–ú–∏—Ä —Å–æ–∑–¥–∞–Ω. –û–∂–∏–¥–∞–Ω–∏–µ –ª–∏–¥–µ—Ä–æ–≤."],
                cells: Array(36).fill(0).map((_, i) => ({owner: Math.floor(i/6), army: 10}))
            });
        } else {
            let d = snap.val();
            if(d.players.length >= 6) return alert("–ú–µ—Å—Ç –Ω–µ—Ç!");
            d.players.push({id: myId, name: nick, cash: 1000, army: 50, eco: 1, countryIdx: d.players.length});
            await ref.update({players: d.players});
        }

        document.getElementById('lobby-wait').style.display = 'block';
        ref.on('value', s => {
            state = s.val();
            if(state.status === 'play') {
                document.getElementById('lobby').style.display = 'none';
                document.getElementById('game').style.display = 'grid';
                render();
            }
        });
    }

    async function start() {
        await db.ref('geofan/r/' + myRoom).update({status: 'play'});
    }

    function render() {
        const me = state.players.find(p => p.id === myId);
        document.getElementById('m-nick').innerText = me.name;
        document.getElementById('m-country').innerText = countryStyles[me.countryIdx].name;
        document.getElementById('m-cash').innerText = Math.floor(me.cash);
        document.getElementById('m-army').innerText = me.army;
        document.getElementById('m-eco').innerText = me.eco.toFixed(1);
        document.getElementById('turn-name').innerText = "–•–æ–¥: " + state.players[state.turn].name;

        const map = document.getElementById('map-area');
        map.innerHTML = '';

        for(let i=0; i<6; i++) {
            const island = document.createElement('div');
            island.className = 'island';
            island.style.clipPath = countryStyles[i].clip;
            island.style.backgroundColor = `rgba(${hexToRgb(countryStyles[i].color)}, 0.15)`;
            
            state.cells.filter((_, idx) => Math.floor(idx/6) === i).forEach((cell, cellIdx) => {
                const globalIdx = i*6 + cellIdx;
                const cDiv = document.createElement('div');
                cDiv.className = 'cell';
                cDiv.style.backgroundColor = countryStyles[cell.owner].color;
                cDiv.innerHTML = `<span class="cell-army">${cell.army}</span>`;
                cDiv.onclick = () => attack(globalIdx);
                island.appendChild(cDiv);
            });
            map.appendChild(island);
        }

        const log = document.getElementById('game-log');
        log.innerHTML = state.log.slice(-10).reverse().map(m => `> ${m}`).join('<br>');
    }

    async function action(type) {
        if(state.players[state.turn].id !== myId) return alert("–ù–µ —Ç–≤–æ–π —Ö–æ–¥!");
        const me = state.players[state.turn];

        if(type === 'eco' && me.cash >= 300) { me.cash -= 300; me.eco += 0.4; state.log.push(`${me.name} —Å—Ç—Ä–æ–∏—Ç –∑–∞–≤–æ–¥—ã.`); }
        else if(type === 'army' && me.cash >= 200) { me.cash -= 200; me.army += 25; state.log.push(`${me.name} –æ–±—É—á–∞–µ—Ç —Å–æ–ª–¥–∞—Ç.`); }
        else if(type === 'end') {
            me.cash += (150 * me.eco);
            state.turn = (state.turn + 1) % state.players.length;
            state.log.push(`–•–æ–¥ –∏–≥—Ä–æ–∫–∞ ${state.players[state.turn].name}`);
        }
        await db.ref('geofan/r/' + myRoom).set(state);
    }

    async function attack(idx) {
        if(state.players[state.turn].id !== myId) return;
        const me = state.players[state.turn];
        const cell = state.cells[idx];
        if(cell.owner === me.countryIdx) return;
        if(me.army < 15) return alert("–ê—Ä–º–∏—è –∏—Å—Ç–æ—â–µ–Ω–∞!");

        const myPower = me.army * (Math.random() + 0.5);
        const enPower = cell.army * (Math.random() + 0.5);

        if(myPower > enPower) {
            state.log.push(`${me.name} –∑–∞—Ö–≤–∞—Ç–∏–ª —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é –Ω–∞ –æ—Å—Ç—Ä–æ–≤–µ ${countryStyles[Math.floor(idx/6)].name}!`);
            cell.owner = me.countryIdx;
            cell.army = Math.floor(me.army / 2);
            me.army = Math.floor(me.army / 2);
        } else {
            state.log.push(`–ê—Ç–∞–∫–∞ ${me.name} –∑–∞—Ö–ª–µ–±–Ω—É–ª–∞—Å—å.`);
            me.army = Math.floor(me.army * 0.4);
        }
        await db.ref('geofan/r/' + myRoom).set(state);
    }

    function hexToRgb(hex) {
        const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
        return `${r}, ${g}, ${b}`;
    }
</script>
</body>
  </html>
